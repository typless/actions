name: 'Run Tests'
description: 'Runnning tests'
inputs:
  python-version:
    description: Input python version
    required: true
  poetry-version:
    description: Input poetry version
    required: false
    default: "1.5.1"
  aws-pypi-username:
    description: Input aws username to access aws pypi bucket
    required: true
  aws-pypi-password:
    description: Input aws password to access aws pypi bucket
    required: true
  working-directory:
    description: Input working directory
    required: true
  test-args:
    description: Arguments added to pytest
    required: true
  coverage-report-path:
    description: Set path to save coverage report. If left empty no report will be saved
    required: false

runs:
  using: composite
  steps:
    - name: Install python dependencies
      uses: typless/actions/install-python-dependencies@v3.0
      with:
        python-version: ${{ inputs.python-version }}
        poetry-version: ${{ inputs.poetry-version }}
        aws-pypi-username: ${{ inputs.aws-pypi-username }}
        aws-pypi-password: ${{ inputs.aws-pypi-password }}
        working-directory: ${{ inputs.working-directory }}
    - name: Run tests
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: poetry run pytest ${{ inputs.test-args }}
    - name: Archive test results
      if: inputs.coverage-report-path != ''
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path:  ${{ inputs.coverage-report-path }}
        retention-days: 5
